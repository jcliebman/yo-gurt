import pygame
import sys
import random
import time

pygame.init()

# Constants
WIDTH, HEIGHT = 800, 600
WHITE = (255, 255, 255)
GRAY = (100, 100, 100)
BLACK = (0, 0, 0)
PADDLE_WIDTH, PADDLE_HEIGHT = 15, 100
BALL_SIZE = 20
FPS = 60
FONT = pygame.font.SysFont("Arial", 15)

# Screen
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Pong with Different Modes and Power-ups!")

# Entities
player = pygame.Rect(WIDTH - 30, HEIGHT // 2 - PADDLE_HEIGHT // 2, PADDLE_WIDTH, PADDLE_HEIGHT)
opponent = pygame.Rect(15, HEIGHT // 2 - PADDLE_HEIGHT // 2, PADDLE_WIDTH, PADDLE_HEIGHT)
ball = pygame.Rect(WIDTH // 2, HEIGHT // 2, BALL_SIZE, BALL_SIZE)

# Movement
ball_speed_map = {"Easy": 6, "Medium": 8, "Hard": 11}
ball_speed_x = 8
ball_speed_y = 8
player_speed = 0
opponent_speed = 7
player_super_speed = 10
opponent_super_speed = 7

# Score
player_score = 0
opponent_score = 0

# AI settings
ai_error_chance = {"Easy": 0.5, "Medium": 0.25, "Hard": 0.05}
difficulty = "Medium"
ai_enabled = True

# Freeze timers
player_frozen = False
player_frozen_end = 0
opponent_frozen = False
opponent_frozen_end = 0

# Ball stop timer
ball_stopped = False
ball_stop_timer = 0

# Power-up linked list classes
class PowerUpNode:
    def __init__(self, powerup):
        self.powerup = powerup
        self.next = None

class PowerUpList:
    def __init__(self):
        self.head = None

    def add_powerup(self, powerup):
        new_node = PowerUpNode(powerup)
        if not self.head:
            self.head = new_node
        else:
            current = self.head
            while current.next:
                current = current.next
            current.next = new_node

    def pop_first(self):
        if not self.head:
            return None
        powerup = self.head.powerup
        self.head = self.head.next
        return powerup

    def is_empty(self):
        return self.head is None

    def __str__(self):
        result = []
        current = self.head
        while current:
            result.append(current.powerup)
            current = current.next
        return " -> ".join(result) if result else "None"

# Power-ups (linked lists)
player_powerups = PowerUpList()
opponent_powerups = PowerUpList()

# Clock
clock = pygame.time.Clock()

def menu_loop(options):
    index = 0
    while True:
        screen.fill(BLACK)
        title = FONT.render("Select Option:", True, WHITE)
        screen.blit(title, (WIDTH // 2 - title.get_width() // 2, 100))

        for i, option in enumerate(options): 
            color = WHITE if i == index else GRAY
            text = FONT.render(option, True, color)
            screen.blit(text, (WIDTH // 2 - text.get_width() // 2, 200 + i * 50))

        pygame.display.flip()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()

            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_UP:
                    index = (index - 1) % len(options)
                elif event.key == pygame.K_DOWN:
                    index = (index + 1) % len(options)
                elif event.key == pygame.K_RETURN:
                    return options[index]

def assign_powerups():
    choices = ["Super Speed", "Freeze", "Stop Ball"]
    # Clear old power-ups and add 1-3 new ones randomly
    player_powerups.head = None
    opponent_powerups.head = None
    for _ in range(random.randint(1, 3)):
        player_powerups.add_powerup(random.choice(choices))
        opponent_powerups.add_powerup(random.choice(choices))

def reset_ball():
    global ball_speed_x, ball_speed_y, ball_stopped, ball_stop_timer
    ball.center = (WIDTH // 2, HEIGHT // 2)
    ball_speed_x = ball_speed_map[difficulty] * random.choice((1, -1))
    ball_speed_y = ball_speed_map[difficulty] * random.choice((1, -1))
    ball_stopped = False
    ball_stop_timer = 0
    assign_powerups()

mode = menu_loop(["Single Player", "Two Player"])
ai_enabled = (mode == "Single Player")
if ai_enabled:
    difficulty = menu_loop(["Easy", "Medium", "Hard"])
reset_ball()

powerup_message = ""
powerup_message_end_time = 0

running = True
player_speed = 0
opponent_speed = 0

while running:
    now = pygame.time.get_ticks()

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        if event.type == pygame.KEYDOWN:
            # Player 1 paddle movement
            if not player_frozen:
                if event.key == pygame.K_UP:
                    player_speed = -player_super_speed
                elif event.key == pygame.K_DOWN:
                    player_speed = player_super_speed
            # Player 2 paddle movement (or AI)
            if not ai_enabled and not opponent_frozen:
                if event.key == pygame.K_w:
                    opponent_speed = -opponent_super_speed
                elif event.key == pygame.K_s:
                    opponent_speed = opponent_super_speed

            # Player 1 uses powerup (Right Shift)
            if event.key == pygame.K_RSHIFT and not player_powerups.is_empty():
                used_powerup = player_powerups.pop_first()
                if used_powerup == "Super Speed":
                    powerup_message = "Player 1 used SUPER SPEED!"
                    # Super speed active while holding keys (already handled)
                elif used_powerup == "Freeze":
                    opponent_frozen = True
                    opponent_frozen_end = now + 2000
                    powerup_message = "Player 1 froze opponent for 2 seconds!"
                elif used_powerup == "Stop Ball":
                    ball_stopped = True
                    ball_stop_timer = now + 2000
                    powerup_message = "Player 1 stopped the ball for 2 seconds!"
                powerup_message_end_time = now + 2000

            # Player 2 uses powerup (Left Shift)
            if not ai_enabled and event.key == pygame.K_LSHIFT and not opponent_powerups.is_empty():
                used_powerup = opponent_powerups.pop_first()
                if used_powerup == "Super Speed":
                    powerup_message = "Player 2 used SUPER SPEED!"
                elif used_powerup == "Freeze":
                    player_frozen = True
                    player_frozen_end = now + 2000
                    powerup_message = "Player 2 froze opponent for 2 seconds!"
                elif used_powerup == "Stop Ball":
                    ball_stopped = True
                    ball_stop_timer = now + 2000
                    powerup_message = "Player 2 stopped the ball for 2 seconds!"
                powerup_message_end_time = now + 2000

        if event.type == pygame.KEYUP:
            if event.key in (pygame.K_UP, pygame.K_DOWN):
                player_speed = 0
            if not ai_enabled and event.key in (pygame.K_w, pygame.K_s):
                opponent_speed = 0
